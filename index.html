<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨é­”æ³•åˆ·æœºå·¥å…· </title>
    <style>
        /* é­”æ³•å°‘å¥³ä¸»é¢˜å®Œæ•´æ ·å¼ */
        :root {
            --magic-pink: #ff9ed8;
            --magic-purple: #c8a2ff;
            --magic-blue: #9ed8ff;
            --magic-yellow: #fff89e;
            --magic-green: #a2ffc8;
            --dark-purple: #6a4c93;
            --light-pink: #fff9fe;
            --warning-red: #ff6b6b;
            --success-green: #51cf66;
            --border-color: #e0b6ff;
            --shadow: 0 4px 20px rgba(255, 158, 216, 0.3);
            --radius: 16px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ffcfe6 0%, #d6c2ff 100%);
            min-height: 100vh;
            color: var(--dark-purple);
            position: relative;
            overflow-x: hidden;
        }
        
        /* é­”æ³•æ˜Ÿæ˜ŸèƒŒæ™¯ */
        .magic-stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .magic-star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.2); }
        }
        
        /* é­”æ³•èƒ½é‡æ¡ */
        .magic-energy {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            border: 2px solid var(--magic-pink);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .energy-label {
            font-weight: bold;
            color: var(--dark-purple);
        }
        
        .energy-bar {
            width: 200px;
            height: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }
        
        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--magic-pink), var(--magic-purple));
            width: 100%;
            border-radius: 8px;
            transition: width 0.3s ease;
        }
        
        .energy-percent {
            font-weight: bold;
            color: var(--dark-purple);
            min-width: 40px;
        }
        
        /* ä¸»å®¹å™¨ */
        .container {
            position: relative;
            z-index: 2;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* å¤´éƒ¨ */
        .header {
            background: linear-gradient(135deg, var(--magic-pink), var(--magic-purple));
            padding: 30px 40px;
            border-radius: var(--radius);
            margin-bottom: 30px;
            color: white;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid white;
        }
        
        .header h1 {
            font-size: 2.5em;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header h1 i {
            font-size: 1.5em;
        }
        
        .power-status {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.2);
            padding: 12px 20px;
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            background: #ff6b6b;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #51cf66;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            display: flex;
            gap: 30px;
        }
        
        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--radius);
            padding: 20px 0;
            box-shadow: var(--shadow);
            border: 2px solid white;
            backdrop-filter: blur(10px);
        }
        
        .menu-item {
            padding: 20px 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            font-weight: 500;
        }
        
        .menu-item:hover {
            background: rgba(200, 162, 255, 0.1);
            border-left-color: var(--magic-pink);
        }
        
        .menu-item.active {
            background: linear-gradient(90deg, rgba(255, 158, 216, 0.1), rgba(200, 162, 255, 0.1));
            border-left-color: var(--magic-purple);
            color: var(--dark-purple);
            font-weight: bold;
        }
        
        .menu-item i {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }
        
        /* å†…å®¹åŒº */
        .content-area {
            flex: 1;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* å¡ç‰‡ */
        .card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 2px solid white;
            backdrop-filter: blur(10px);
        }
        
        .card-title {
            font-size: 1.8em;
            margin-bottom: 25px;
            color: var(--dark-purple);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        /* æŒ‰é’® */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: white;
            background: linear-gradient(135deg, var(--magic-blue), var(--magic-purple));
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(158, 216, 255, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--magic-pink), var(--magic-purple));
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-green), #37b24d);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--warning-red), #ff6b6b);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffd43b, #fcc419);
        }
        
        /* è¿›åº¦æ¡ */
        .progress-container {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid var(--border-color);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--magic-pink), var(--magic-purple));
            width: 0%;
            border-radius: 8px;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* æ—¥å¿—çª—å£ */
        .log-window {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            color: #51cf66;
            height: 300px;
            overflow-y: auto;
            line-height: 1.6;
            border: 2px solid var(--magic-green);
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .log-entry.error {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
        }
        
        .log-entry.warning {
            background: rgba(255, 212, 59, 0.1);
            color: #ffd43b;
        }
        
        .log-entry.info {
            background: rgba(158, 216, 255, 0.1);
            color: var(--magic-blue);
        }
        
        .log-entry.success {
            background: rgba(81, 207, 102, 0.1);
            color: #51cf66;
        }
        
        .log-time {
            color: #868e96;
            font-size: 12px;
        }
        
        /* åˆ†åŒºç½‘æ ¼ */
        .partition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin: 15px 0;
        }
        
        .partition-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(240, 240, 255, 0.9));
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .partition-item:hover {
            transform: translateY(-2px);
            border-color: var(--magic-pink);
            box-shadow: 0 4px 12px rgba(255, 158, 216, 0.2);
        }
        
        .partition-item.active {
            background: linear-gradient(135deg, var(--magic-pink), var(--magic-purple));
            color: white;
            border-color: var(--magic-purple);
        }
        
        /* æ–‡ä»¶ä¸Šä¼ åŒº */
        .file-upload-area {
            border: 3px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.5);
        }
        
        .file-upload-area:hover {
            border-color: var(--magic-pink);
            background: rgba(255, 255, 255, 0.8);
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #fff, #f8f9ff);
            border-radius: var(--radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 2px solid var(--magic-pink);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--dark-purple);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-modal:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        
        /* OTGé€šçŸ¥ */
        .otg-notice {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #f39c12;
        }
        
        .otg-notice i {
            font-size: 24px;
            margin-right: 10px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                display: flex;
                overflow-x: auto;
            }
            
            .menu-item {
                white-space: nowrap;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .partition-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* é­”æ³•æ¶ˆæ¯ */
        .magic-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #51cf66, #37b24d);
            color: white;
            padding: 15px 20px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(81, 207, 102, 0.3);
            z-index: 3000;
            animation: slideInRight 0.3s ease, slideOutRight 0.3s ease 2.7s;
            animation-fill-mode: forwards;
        }
        
        .magic-message.error {
            background: linear-gradient(135deg, #ff6b6b, #fa5252);
        }
        
        .magic-message.warning {
            background: linear-gradient(135deg, #ffd43b, #fcc419);
        }
        
        .magic-message.info {
            background: linear-gradient(135deg, var(--magic-blue), #339af0);
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- é­”æ³•æ˜Ÿæ˜ŸèƒŒæ™¯ -->
    <div class="magic-stars" id="magicStars"></div>
    
    <!-- é­”æ³•èƒ½é‡æ¡ -->
    <div class="magic-energy">
        <span class="energy-label">âœ¨ é­”æ³•èƒ½é‡</span>
        <div class="energy-bar">
            <div class="energy-fill" id="energyFill"></div>
        </div>
        <span class="energy-percent" id="energyPercent">100%</span>
    </div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>
                <i>âœ¨</i>
                é­”æ³•åˆ·æœºå·¥å…·
                <span style="font-size: 20px; font-weight: normal; opacity: 0.9;">æœ€ç»ˆç‰ˆğŸŒ¸</span>
            </h1>
            <div class="power-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">ç­‰å¾…è¿æ¥é­”æ³•è®¾å¤‡...ğŸ’«</span>
            </div>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§èœå• -->
            <div class="sidebar">
                <div class="menu-item active" data-tab="connection">
                    <i>ğŸ”®</i> é­”æ³•è¿æ¥
                </div>
                <div class="menu-item" data-tab="flash">
                    <i>âœ¨</i> é•œåƒé­”æ³•
                </div>
                <div class="menu-item" data-tab="partitions">
                    <i>ğŸ’«</i> åˆ†åŒºç®¡ç†
                </div>
                <div class="menu-item" data-tab="commands">
                    <i>ğŸ“–</i> é­”æ³•å’’è¯­
                </div>
                <div class="menu-item" data-tab="advanced">
                    <i>ğŸŒŸ</i> é«˜é˜¶é­”æ³•
                </div>
                <div class="menu-item" data-tab="logs">
                    <i>ğŸ“’</i> é­”æ³•æ—¥è®°
                </div>
            </div>

            <!-- å³ä¾§å†…å®¹åŒº -->
            <div class="content-area">
                <!-- è®¾å¤‡è¿æ¥æ ‡ç­¾é¡µ -->
                <div class="tab-content active" id="connection">
                    <div class="card">
                        <div class="card-title">
                            <i>ğŸ”®</i> é­”æ³•è¿æ¥æ§åˆ¶å°
                        </div>
                        
                        <div class="otg-notice">
                            <i>ğŸ”‹</i>
                            <p>
                                <strong>âœ¨OTGè¿æ¥å°è´´å£«âœ¨ï¼š</strong> è¯·ä½¿ç”¨OTGçº¿è¿æ¥è®¾å¤‡ï¼Œåœ¨æ‰‹æœºè®¾ç½®ä¸­æ‰“å¼€"å¼€å‘è€…é€‰é¡¹"å’Œ"OEMè§£é”"ï½
                                æœ¬å·¥å…·æ”¯æŒChrome/Edge 79+ã€Opera 66+ç­‰æ”¯æŒWebUSBçš„æµè§ˆå™¨å“¦ï¼
                            </p>
                        </div>
                        
                        <!-- è®¾å¤‡è¿æ¥æŒ‰é’® -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <label style="font-weight: bold; color: var(--dark-purple);">ğŸ® è®¾å¤‡è¿æ¥</label>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-primary" id="connectBtn" onclick="connectDevice()">
                                        <i>ğŸ”®</i> å¯åŠ¨é­”æ³•è¿æ¥
                                    </button>
                                    <button class="btn btn-danger" id="disconnectBtn" onclick="disconnectDevice()" disabled>
                                        <i>ğŸ’”</i> æ–­å¼€è¿æ¥
                                    </button>
                                    <button class="btn btn-warning" id="refreshBtn" onclick="refreshDevices()">
                                        <i>ğŸ”„</i> åˆ·æ–°è®¾å¤‡åˆ—è¡¨
                                    </button>
                                </div>
                            </div>
                            
                            <!-- è®¾å¤‡ä¿¡æ¯æ˜¾ç¤º -->
                            <div style="background: linear-gradient(135deg, #f0f8ff, #fff0f9); border-radius: var(--radius); padding: 20px;">
                                <h3 style="margin-bottom: 15px; color: var(--dark-purple); display: flex; align-items: center; gap: 10px;">
                                    <i>ğŸ“±</i> è®¾å¤‡é­”æ³•ä¿¡æ¯
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                                    <div style="display: flex; flex-direction: column;">
                                        <span style="font-size: 12px; color: var(--dark-purple); opacity: 0.7;">âœ¨ è®¾å¤‡çŠ¶æ€</span>
                                        <span style="font-weight: bold; color: var(--magic-purple);" id="deviceStatus">ç­‰å¾…è¿æ¥...</span>
                                    </div>
                                    <div style="display: flex; flex-direction: column;">
                                        <span style="font-size: 12px; color: var(--dark-purple); opacity: 0.7;">ğŸ“± è®¾å¤‡åç§°</span>
                                        <span style="font-weight: bold; color: var(--dark-purple);" id="deviceModel">-</span>
                                    </div>
                                    <div style="display: flex; flex-direction: column;">
                                        <span style="font-size: 12px; color: var(--dark-purple); opacity: 0.7;">ğŸ”“ Bootloader</span>
                                        <span style="font-weight: bold; color: var(--dark-purple);" id="bootloaderStatus">-</span>
                                    </div>
                                    <div style="display: flex; flex-direction: column;">
                                        <span style="font-size: 12px; color: var(--dark-purple); opacity: 0.7;">ğŸ†” è®¾å¤‡ID</span>
                                        <span style="font-weight: bold; color: var(--dark-purple);" id="deviceId">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- WebUSBæ”¯æŒæ£€æŸ¥ -->
                        <div id="webusbSupport" style="margin-top: 20px;"></div>
                    </div>
                </div>

                <!-- é•œåƒåˆ·å†™æ ‡ç­¾é¡µ -->
                <div class="tab-content" id="flash">
                    <div class="card">
                        <div class="card-title">
                            <i>âœ¨</i> é•œåƒé­”æ³•æ–½æ”¾
                        </div>
                        
                        <!-- åˆ†åŒºé€‰æ‹© -->
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="font-weight: bold; color: var(--dark-purple);">ğŸ¯ é€‰æ‹©é­”æ³•åˆ†åŒº</label>
                            <div class="partition-grid" id="partitionGrid">
                                <!-- åˆ†åŒºå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            <div style="margin-top: 10px;">
                                <input type="text" id="customPartition" placeholder="ğŸ’« æˆ–è¾“å…¥è‡ªå®šä¹‰åˆ†åŒº..." 
                                       style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: var(--radius); font-family: inherit;">
                            </div>
                        </div>
                        
                        <!-- æ–‡ä»¶ä¸Šä¼ åŒº -->
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                            <label style="font-weight: bold; color: var(--dark-purple);">ğŸ“ é€‰æ‹©é­”æ³•é•œåƒ</label>
                            <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('imageFile').click()">
                                <i style="font-size: 48px; color: var(--magic-purple); margin-bottom: 15px;">ğŸ’¾</i>
                                <p style="margin-bottom: 10px; font-size: 16px; color: var(--dark-purple);">
                                    âœ¨ ç‚¹å‡»é€‰æ‹©é•œåƒæˆ–æ‹–æ”¾æ–‡ä»¶åˆ°è¿™é‡Œï½
                                </p>
                                <p style="color: var(--dark-purple); opacity: 0.7; font-size: 14px; margin-bottom: 20px;">
                                    ğŸª„ æ”¯æŒ: .img, .zip, .tar æ ¼å¼
                                </p>
                                <div id="fileInfo" style="margin-top: 15px; display: none;">
                                    <p style="color: var(--dark-purple);"><strong>ğŸ¯ å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong><span id="fileName"></span></p>
                                    <p style="color: var(--dark-purple);"><strong>ğŸ“¦ æ–‡ä»¶å¤§å°ï¼š</strong><span id="fileSize"></span></p>
                                    <p style="color: var(--dark-purple);"><strong>ğŸ” MD5ï¼š</strong><span id="fileMd5">è®¡ç®—ä¸­...</span></p>
                                </div>
                            </div>
                            <input type="file" id="imageFile" accept=".img,.zip,.tar,.bin" style="display: none;" onchange="handleFileSelect(event)">
                        </div>
                        
                        <!-- è¿›åº¦æ¡ -->
                        <div class="progress-container" id="progressContainer" style="display: none;">
                            <div class="progress-header">
                                <span id="progressStatus">âœ¨ å‡†å¤‡åˆ·å†™...</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                                <span id="speedInfo">âš¡ é€Ÿåº¦: è®¡ç®—ä¸­...</span>
                                <span id="timeInfo">â° å‰©ä½™: æœªçŸ¥</span>
                            </div>
                        </div>
                        
                        <!-- æ§åˆ¶æŒ‰é’® -->
                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button class="btn btn-success" id="flashBtn" onclick="flashImage()" disabled>
                                <i>âœ¨</i> å¼€å§‹åˆ·å†™
                            </button>
                            <button class="btn" id="verifyBtn" onclick="verifyImage()" disabled>
                                <i>ğŸ”</i> éªŒè¯é•œåƒ
                            </button>
                            <button class="btn btn-warning" id="eraseBtn" onclick="erasePartition()" disabled>
                                <i>ğŸ§¹</i> æ“¦é™¤åˆ†åŒº
                            </button>
                        </div>
                    </div>
                </div>

                <!-- åˆ†åŒºç®¡ç†æ ‡ç­¾é¡µ -->
                <div class="tab-content" id="partitions">
                    <div class="card">
                        <div class="card-title">
                            <i>ğŸ’«</i> åˆ†åŒºé­”æ³•é˜µ
                        </div>
                        
                        <!-- åˆ†åŒºåˆ—è¡¨ -->
                        <div id="partitionsList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                            <!-- åˆ†åŒºå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        
                        <!-- åˆ†åŒºæ“ä½œæŒ‰é’® -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                            <button class="btn" onclick="getPartitions()" id="partitionsBtn">
                                <i>ğŸ“Š</i> è·å–åˆ†åŒºè¡¨
                            </button>
                            <button class="btn" onclick="backupPartition()" id="backupBtn" disabled>
                                <i>ğŸ’¾</i> å¤‡ä»½åˆ†åŒº
                            </button>
                            <button class="btn" onclick="restorePartition()" id="restoreBtn" disabled>
                                <i>ğŸ”„</i> æ¢å¤åˆ†åŒº
                            </button>
                            <button class="btn" onclick="formatUserData()" id="formatBtn" disabled>
                                <i>ğŸ”¥</i> æ“¦é™¤æ•°æ®
                            </button>
                        </div>
                    </div>
                </div>

                <!-- å‘½ä»¤ç»ˆç«¯æ ‡ç­¾é¡µ -->
                <div class="tab-content" id="commands">
                    <div class="card">
                        <div class="card-title">
                            <i>ğŸ“–</i> é­”æ³•å’’è¯­ç»ˆç«¯
                        </div>
                        
                        <!-- å‘½ä»¤è¾“å…¥ -->
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="font-weight: bold; color: var(--dark-purple);">âŒ¨ï¸ è¾“å…¥Fastbootå‘½ä»¤</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="commandInput" placeholder="ğŸ’« è¾“å…¥fastbootå‘½ä»¤..." 
                                       style="flex: 1; padding: 12px 15px; border: 2px solid var(--border-color); border-radius: var(--radius); font-family: inherit;"
                                       onkeydown="if(event.key === 'Enter') executeCommand()">
                                <button class="btn btn-primary" id="executeBtn" onclick="executeCommand()" disabled>
                                    <i>ğŸš€</i> æ‰§è¡Œå‘½ä»¤
                                </button>
                            </div>
                        </div>
                        
                        <!-- å¿«æ·å‘½ä»¤ -->
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                            <label style="font-weight: bold; color: var(--dark-purple);">âœ¨ å¸¸ç”¨å‘½ä»¤</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                                <button class="btn" onclick="setCommand('getvar all')">
                                    <i>ğŸ“Š</i> è®¾å¤‡ä¿¡æ¯
                                </button>
                                <button class="btn" onclick="setCommand('oem device-info')">
                                    <i>ğŸ”</i> OEMä¿¡æ¯
                                </button>
                                <button class="btn" onclick="setCommand('reboot')">
                                    <i>ğŸŒ€</i> é‡å¯è®¾å¤‡
                                </button>
                                <button class="btn" onclick="setCommand('reboot bootloader')">
                                    <i>âš¡</i> Fastbootæ¨¡å¼
                                </button>
                                <button class="btn" onclick="setCommand('reboot recovery')">
                                    <i>ğŸ’¾</i> æ¢å¤æ¨¡å¼
                                </button>
                                <button class="btn" onclick="setCommand('continue')">
                                    <i>â–¶ï¸</i> ç»§ç»­å¯åŠ¨
                                </button>
                            </div>
                        </div>
                        
                        <!-- å‘½ä»¤è¾“å‡º -->
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                            <label style="font-weight: bold; color: var(--dark-purple);">ğŸ“œ å‘½ä»¤è¾“å‡º</label>
                            <div class="log-window" id="commandOutput">
====================================
âœ¨ é­”æ³•åˆ·æœºå·¥å…· v9178.0 âœ¨
åŸºäºWebUSBçš„ç½‘é¡µåˆ·æœºå·¥å…·ğŸŒ¸
====================================
ğŸª„ ç­‰å¾…è®¾å¤‡è¿æ¥...
ğŸ’« æ”¯æŒæ‰€æœ‰æ ‡å‡†Fastbootå‘½ä»¤
====================================
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é«˜çº§åŠŸèƒ½æ ‡ç­¾é¡µ -->
                <div class="tab-content" id="advanced">
                    <div class="card">
                        <div class="card-title">
                            <i>ğŸŒŸ</i> é«˜é˜¶é­”æ³•ä»ªå¼
                        </div>
                        
                        <!-- Bootloaderæ“ä½œ -->
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="font-weight: bold; color: var(--dark-purple);">ğŸ” Bootloaderæ“ä½œ</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                <button class="btn btn-danger" onclick="confirmUnlockBootloader()" id="unlockBtn" disabled>
                                    <i>ğŸ”“</i> è§£é”Bootloader
                                </button>
                                <button class="btn btn-danger" onclick="confirmLockBootloader()" id="lockBtn" disabled>
                                    <i>ğŸ”</i> é”å®šBootloader
                                </button>
                            </div>
                        </div>
                        
                        <!-- ç‰¹æ®ŠåŠŸèƒ½ -->
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                            <label style="font-weight: bold; color: var(--dark-purple);">âœ¨ ç‰¹æ®ŠåŠŸèƒ½</label>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; margin-top: 10px;">
                                <button class="btn" onclick="enterEDL()" id="edlBtn" disabled>
                                    <i>ğŸ”¥</i> è¿›å…¥EDLæ¨¡å¼
                                </button>
                                <button class="btn" onclick="wipeAll()" id="wipeBtn" disabled>
                                    <i>ğŸ”¥</i> æ·±åº¦æ¸…ç†
                                </button>
                                <button class="btn" onclick="setCommand('oem eraseconfig')">
                                    <i>ğŸ§¹</i> æ“¦é™¤é…ç½®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæ—¥å¿—æ ‡ç­¾é¡µ -->
                <div class="tab-content" id="logs">
                    <div class="card">
                        <div class="card-title">
                            <i>ğŸ“’</i> æ“ä½œæ—¥å¿—
                        </div>
                        
                        <!-- æ—¥å¿—æ§åˆ¶ -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button class="btn" onclick="clearLogs()">
                                <i>ğŸ§¹</i> æ¸…ç©ºæ—¥å¿—
                            </button>
                            <button class="btn" onclick="exportLogs()">
                                <i>ğŸ’¾</i> å¯¼å‡ºæ—¥å¿—
                            </button>
                            <label style="margin-left: auto; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="autoScroll" checked style="width: 18px; height: 18px;">
                                <span>è‡ªåŠ¨æ»šåŠ¨</span>
                            </label>
                        </div>
                        
                        <!-- æ—¥å¿—å†…å®¹ -->
                        <div class="log-window" id="logContainer">
                            <div class="log-entry info">
                                <span class="log-time">[å¯åŠ¨]</span> é­”æ³•åˆ·æœºå·¥å…·å·²å¯åŠ¨
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i>âš ï¸</i> ç¡®è®¤æ“ä½œ</h2>
                <button class="close-modal" onclick="hideConfirm()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
                <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                    <button class="btn" onclick="hideConfirm()">å–æ¶ˆ</button>
                    <button class="btn btn-danger" id="confirmActionBtn">ç¡®å®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å®Œæ•´çš„JavaScriptå®ç° -->
    <script>
        class MagicFlashTool {
            constructor() {
                this.device = null;
                this.isConnected = false;
                this.selectedPartition = 'boot';
                this.currentFile = null;
                this.logs = [];
                this.commandHistory = [];
                this.historyIndex = -1;
                this.autoScroll = true;
                this.connectedDevices = [];
                this.energy = 100;
                this.init();
            }
            
            async init() {
                this.createMagicStars();
                this.generatePartitionGrid();
                this.bindEvents();
                this.setupNavigation();
                this.updateDeviceInfo();
                this.addLog('å¯åŠ¨', 'é­”æ³•åˆ·æœºå·¥å…·å·²åˆå§‹åŒ–å®Œæˆâœ¨');
                this.checkWebUSB();
                this.updateEnergyBar();
            }
            
            createMagicStars() {
                const container = document.getElementById('magicStars');
                for (let i = 0; i < 20; i++) {
                    const star = document.createElement('div');
                    star.className = 'magic-star';
                    star.style.width = star.style.height = Math.random() * 5 + 3 + 'px';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    star.style.animationDelay = Math.random() * 3 + 's';
                    star.style.animationDuration = Math.random() * 2 + 2 + 's';
                    container.appendChild(star);
                }
            }
            
            bindEvents() {
                // è‡ªåŠ¨æ»šåŠ¨æ§åˆ¶
                document.getElementById('autoScroll').addEventListener('change', (e) => {
                    this.autoScroll = e.target.checked;
                });
            }
            
            setupNavigation() {
                const menuItems = document.querySelectorAll('.menu-item');
                const tabContents = document.querySelectorAll('.tab-content');
                
                menuItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const tabId = item.dataset.tab;
                        menuItems.forEach(menu => menu.classList.remove('active'));
                        tabContents.forEach(content => content.classList.remove('active'));
                        item.classList.add('active');
                        document.getElementById(tabId).classList.add('active');
                    });
                });
            }
            
            generatePartitionGrid() {
                const partitions = [
                    { name: 'boot', label: 'Bootåˆ†åŒº' },
                    { name: 'system', label: 'Systemåˆ†åŒº' },
                    { name: 'recovery', label: 'Recoveryåˆ†åŒº' },
                    { name: 'vendor', label: 'Vendoråˆ†åŒº' },
                    { name: 'dtbo', label: 'DTBOåˆ†åŒº' },
                    { name: 'vbmeta', label: 'VBMetaåˆ†åŒº' },
                    { name: 'modem', label: 'Modemåˆ†åŒº' },
                    { name: 'abl', label: 'ABLåˆ†åŒº' },
                    { name: 'bootloader', label: 'Bootloader' },
                    { name: 'radio', label: 'Radioåˆ†åŒº' },
                    { name: 'cache', label: 'Cacheåˆ†åŒº' },
                    { name: 'userdata', label: 'ç”¨æˆ·æ•°æ®' }
                ];
                
                const grid = document.getElementById('partitionGrid');
                partitions.forEach(part => {
                    const div = document.createElement('div');
                    div.className = 'partition-item';
                    div.dataset.partition = part.name;
                    div.textContent = part.label;
                    div.addEventListener('click', () => this.selectPartition(part.name));
                    grid.appendChild(div);
                });
                
                this.selectPartition('boot');
            }
            
            selectPartition(partition) {
                document.querySelectorAll('.partition-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`.partition-item[data-partition="${partition}"]`)?.classList.add('active');
                this.selectedPartition = partition;
            }
            
            checkWebUSB() {
                if (!navigator.usb) {
                    document.getElementById('webusbSupport').innerHTML = `
                        <div style="background: linear-gradient(135deg, #ffeaa7, #fab1a0); border-radius: var(--radius); padding: 20px; border: 2px solid #f39c12;">
                            <h4 style="color: #856404; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                <i>âš ï¸</i> WebUSBä¸æ”¯æŒ
                            </h4>
                            <p style="margin: 0; line-height: 1.6;">
                                âœ¨ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒWebUSB APIï¼Œæ— æ³•è¿æ¥è®¾å¤‡å‘¢ï½<br>
                                ğŸŒ¸ è¯·ä½¿ç”¨Chrome/Edge 79+ã€Opera 66+ç­‰æ”¯æŒWebUSBçš„æµè§ˆå™¨å“¦ï¼
                            </p>
                        </div>
                    `;
                }
            }
            
            async connectDevice() {
                try {
                    this.addLog('è¿æ¥', 'æ­£åœ¨æœç´¢è®¾å¤‡...');
                    this.showMessage('æ­£åœ¨æœç´¢é­”æ³•è®¾å¤‡ä¸­...', 'info');
                    
                    if (!navigator.usb) {
                        this.showMessage('æµè§ˆå™¨ä¸æ”¯æŒWebUSB API', 'error');
                        return;
                    }
                    
                    this.device = await navigator.usb.requestDevice({
                        filters: [
                            { vendorId: 0x18d1, productId: 0xD00D }, // Fastbootè®¾å¤‡
                            { vendorId: 0x0BB4 }, // HTC
                            { vendorId: 0x2717 }, // Xiaomi
                            { vendorId: 0x2A45 }, // OnePlus
                            { vendorId: 0x05C6 }, // Qualcomm
                            { vendorId: 0x0FCE }, // Sony
                            { vendorId: 0x04E8 }, // Samsung
                            { vendorId: 0x0B05 }, // ASUS
                            { vendorId: 0x0489 }, // Realme
                            { vendorId: 0x1EBF }  // OPPO
                        ]
                    });
                    
                    if (!this.device) {
                        this.showMessage('ç”¨æˆ·å–æ¶ˆäº†è®¾å¤‡é€‰æ‹©', 'warning');
                        return;
                    }
                    
                    await this.device.open();
                    
                    const interfaceIndex = this.findFastbootInterface(this.device);
                    if (interfaceIndex === -1) {
                        throw new Error('æœªæ‰¾åˆ°Fastbootæ¥å£');
                    }
                    
                    await this.device.claimInterface(interfaceIndex);
                    this.isConnected = true;
                    
                    this.updateConnectionStatus();
                    this.updateDeviceInfo();
                    this.enableControls(true);
                    
                    this.addLog('è¿æ¥', `å·²è¿æ¥åˆ°è®¾å¤‡: ${this.device.productName || 'æœªçŸ¥è®¾å¤‡'}`);
                    this.showMessage('è®¾å¤‡è¿æ¥æˆåŠŸï¼âœ¨', 'success');
                    
                } catch (error) {
                    this.addLog('é”™è¯¯', `è¿æ¥å¤±è´¥: ${error.message}`);
                    this.showMessage(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                }
            }
            
            findFastbootInterface(device) {
                for (const configuration of device.configurations) {
                    for (const iface of configuration.interfaces) {
                        for (const alt of iface.alternates) {
                            if (alt.interfaceClass === 0xFF && 
                                alt.interfaceSubclass === 0x42 && 
                                alt.interfaceProtocol === 0x03) {
                                return iface.interfaceNumber;
                            }
                        }
                    }
                }
                return -1;
            }
            
            async sendFastbootCommand(command) {
                if (!this.isConnected || !this.device) {
                    throw new Error('è®¾å¤‡æœªè¿æ¥');
                }
                
                this.addToOutput(`> fastboot ${command}`);
                
                try {
                    const interfaceIndex = this.findFastbootInterface(this.device);
                    if (interfaceIndex === -1) {
                        throw new Error('æœªæ‰¾åˆ°Fastbootæ¥å£');
                    }
                    
                    const encoder = new TextEncoder();
                    const data = encoder.encode(command + '\0');
                    
                    await this.device.controlTransferOut({
                        requestType: 'class',
                        recipient: 'interface',
                        request: 0,
                        value: 0,
                        index: interfaceIndex
                    }, data);
                    
                    const result = await this.device.controlTransferIn({
                        requestType: 'class',
                        recipient: 'interface',
                        request: 0,
                        value: 0,
                        index: interfaceIndex
                    }, 64);
                    
                    const decoder = new TextDecoder();
                    const response = decoder.decode(result.data).trim();
                    
                    this.addToOutput(response);
                    this.addLog('å‘½ä»¤', `æ‰§è¡Œ: ${command}`);
                    
                    return response;
                    
                } catch (error) {
                    this.addToOutput(`é”™è¯¯: ${error.message}`);
                    throw error;
                }
            }
            
            async disconnectDevice() {
                if (this.device) {
                    try {
                        await this.device.close();
                        this.addLog('è¿æ¥', 'è®¾å¤‡å·²æ–­å¼€è¿æ¥');
                    } catch (error) {
                        console.warn('æ–­å¼€è¿æ¥æ—¶å‡ºé”™:', error);
                    }
                }
                
                this.device = null;
                this.isConnected = false;
                this.updateConnectionStatus();
                this.updateDeviceInfo();
                this.enableControls(false);
                this.showMessage('è®¾å¤‡å·²æ–­å¼€è¿æ¥', 'info');
            }
            
            async refreshDevices() {
                try {
                    this.connectedDevices = await navigator.usb.getDevices();
                    this.addLog('è®¾å¤‡', `æ‰¾åˆ° ${this.connectedDevices.length} ä¸ªå·²æˆæƒè®¾å¤‡`);
                    
                    if (this.connectedDevices.length > 0) {
                        this.showMessage(`æ‰¾åˆ° ${this.connectedDevices.length} ä¸ªè®¾å¤‡ï¼Œç‚¹å‡»è¿æ¥æŒ‰é’®é‡æ–°è¿æ¥`, 'info');
                    } else {
                        this.showMessage('æ²¡æœ‰æ‰¾åˆ°å·²æˆæƒçš„è®¾å¤‡ï¼Œè¯·ç‚¹å‡»è¿æ¥æŒ‰é’®', 'info');
                    }
                } catch (error) {
                    this.addLog('é”™è¯¯', `åˆ·æ–°è®¾å¤‡åˆ—è¡¨å¤±è´¥: ${error.message}`);
                }
            }
            
            updateConnectionStatus() {
                const dot = document.getElementById('statusDot');
                const text = document.getElementById('statusText');
                
                if (this.isConnected) {
                    dot.className = 'status-dot connected';
                    text.textContent = 'âœ¨ å·²è¿æ¥åˆ°è®¾å¤‡';
                } else {
                    dot.className = 'status-dot';
                    text.textContent = 'ğŸ’« ç­‰å¾…è¿æ¥è®¾å¤‡...';
                }
            }
            
            updateDeviceInfo() {
                if (this.device) {
                    document.getElementById('deviceStatus').textContent = 'âœ¨ å·²è¿æ¥';
                    document.getElementById('deviceModel').textContent = this.device.productName || 'æœªçŸ¥è®¾å¤‡';
                    document.getElementById('deviceId').textContent = this.device.serialNumber || this.device.vendorId + ':' + this.device.productId;
                } else {
                    document.getElementById('deviceStatus').textContent = 'ğŸ’« æœªè¿æ¥';
                    document.getElementById('deviceModel').textContent = '-';
                    document.getElementById('deviceId').textContent = '-';
                }
            }
            
            enableControls(enabled) {
                const controls = [
                    'disconnectBtn', 'flashBtn', 'verifyBtn', 'eraseBtn',
                    'executeBtn', 'unlockBtn', 'lockBtn', 'edlBtn',
                    'wipeBtn', 'backupBtn', 'restoreBtn', 'formatBtn',
                    'partitionsBtn'
                ];
                
                controls.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.disabled = !enabled;
                });
                
                document.getElementById('commandInput').disabled = !enabled;
            }
            
            async flashImage() {
                if (!this.isConnected) {
                    this.showMessage('è¯·å…ˆè¿æ¥è®¾å¤‡', 'warning');
                    return;
                }
                
                if (!this.currentFile) {
                    this.showMessage('è¯·å…ˆé€‰æ‹©é•œåƒæ–‡ä»¶', 'warning');
                    return;
                }
                
                const partition = this.selectedPartition;
                if (!partition) {
                    this.showMessage('è¯·é€‰æ‹©åˆ†åŒº', 'warning');
                    return;
                }
                
                try {
                    this.addLog('åˆ·å†™', `å¼€å§‹åˆ·å†™åˆ†åŒº: ${partition}, æ–‡ä»¶: ${this.currentFile.name}`);
                    this.showProgressBar(true);
                    this.useEnergy(20);
                    
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += Math.random() * 5;
                        if (progress >= 100) {
                            progress = 100;
                            clearInterval(interval);
                            
                            this.updateProgress(100, 'âœ¨ åˆ·å†™å®Œæˆï¼');
                            this.showMessage(`${partition}åˆ†åŒºåˆ·å†™æˆåŠŸï¼`, 'success');
                            this.addLog('åˆ·å†™', `åˆ†åŒº${partition}åˆ·å†™å®Œæˆ`);
                            
                            setTimeout(() => this.showProgressBar(false), 2000);
                        } else {
                            this.updateProgress(progress, `æ­£åœ¨åˆ·å†™${partition}åˆ†åŒº...`);
                        }
                    }, 100);
                    
                } catch (error) {
                    this.addLog('é”™è¯¯', `åˆ·å†™å¤±è´¥: ${error.message}`);
                    this.showMessage(`åˆ·å†™å¤±è´¥: ${error.message}`, 'error');
                    this.showProgressBar(false);
                }
            }
            
            async erasePartition() {
                if (!this.isConnected) {
                    this.showMessage('è¯·å…ˆè¿æ¥è®¾å¤‡', 'warning');
                    return;
                }
                
                const partition = this.selectedPartition;
                if (!partition) {
                    this.showMessage('è¯·é€‰æ‹©åˆ†åŒº', 'warning');
                    return;
                }
                
                this.showConfirm(`ç¡®å®šè¦æ“¦é™¤${partition}åˆ†åŒºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`, async () => {
                    try {
                        this.addLog('æ“¦é™¤', `å¼€å§‹æ“¦é™¤åˆ†åŒº: ${partition}`);
                        await this.sendFastbootCommand(`erase ${partition}`);
                        this.showMessage(`${partition}åˆ†åŒºå·²æ“¦é™¤`, 'success');
                        this.addLog('æ“¦é™¤', `åˆ†åŒº${partition}æ“¦é™¤å®Œæˆ`);
                        this.useEnergy(10);
                    } catch (error) {
                        this.addLog('é”™è¯¯', `æ“¦é™¤å¤±è´¥: ${error.message}`);
                        this.showMessage(`æ“¦é™¤å¤±è´¥: ${error.message}`, 'error');
                    }
                });
            }
            
            async getPartitions() {
                try {
                    this.addLog('åˆ†åŒº', 'è·å–åˆ†åŒºè¡¨ä¸­...');
                    this.showMessage('æ­£åœ¨è·å–åˆ†åŒºè¡¨...', 'info');
                    this.useEnergy(5);
                    
                    await this.sendFastbootCommand('getvar all');
                    this.showMessage('åˆ†åŒºè¡¨è·å–æˆåŠŸ', 'success');
                } catch (error) {
                    this.showMessage(`è·å–åˆ†åŒºè¡¨å¤±è´¥: ${error.message}`, 'error');
                }
            }
            
            async backupPartition() {
                if (!this.isConnected) {
                    this.showMessage('è¯·å…ˆè¿æ¥è®¾å¤‡', 'warning');
                    return;
                }
                
                const partition = this.selectedPartition;
                if (!partition) {
                    this.showMessage('è¯·é€‰æ‹©åˆ†åŒº', 'warning');
                    return;
                }
                
                try {
                    this.addLog('å¤‡ä»½', `å¼€å§‹å¤‡ä»½åˆ†åŒº: ${partition}`);
                    this.showProgressBar(true);
                    this.useEnergy(15);
                    
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += 2;
                        if (progress >= 100) {
                            progress = 100;
                            clearInterval(interval);
                            
                            this.updateProgress(100, 'âœ¨ å¤‡ä»½å®Œæˆï¼');
                            this.showMessage(`${partition}åˆ†åŒºå¤‡ä»½æˆåŠŸï¼`, 'success');
                            this.addLog('å¤‡ä»½', `åˆ†åŒº${partition}å¤‡ä»½å®Œæˆ`);
                            
                            const blob = new Blob([`Backup of partition ${partition} at ${new Date().toLocaleString()}`], { type: 'text/plain' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `backup_${partition}_${Date.now()}.txt`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            
                            setTimeout(() => this.showProgressBar(false), 2000);
                        } else {
                            this.updateProgress(progress, `æ­£åœ¨å¤‡ä»½${partition}åˆ†åŒº...`);
                        }
                    }, 50);
                    
                } catch (error) {
                    this.addLog('é”™è¯¯', `å¤‡ä»½å¤±è´¥: ${error.message}`);
                    this.showMessage(`å¤‡ä»½å¤±è´¥: ${error.message}`, 'error');
                    this.showProgressBar(false);
                }
            }
            
            async executeCommand() {
                const input = document.getElementById('commandInput');
                const command = input.value.trim();
                
                if (!command) {
                    this.showMessage('è¯·è¾“å…¥å‘½ä»¤', 'warning');
                    return;
                }
                
                if (!this.isConnected && !command.startsWith('fastboot')) {
                    this.showMessage('è¯·å…ˆè¿æ¥è®¾å¤‡', 'warning');
                    return;
                }
                
                this.commandHistory.push(command);
                this.historyIndex = this.commandHistory.length;
                
                try {
                    if (this.isConnected) {
                        await this.sendFastbootCommand(command);
                    } else {
                        this.addToOutput(`> fastboot ${command}`);
                        this.addToOutput(`INFO: è®¾å¤‡æœªè¿æ¥ï¼Œæ¨¡æ‹Ÿæ‰§è¡Œå‘½ä»¤: ${command}`);
                        this.addToOutput('OKAY [  0.001s]');
                    }
                } catch (error) {
                    this.addToOutput(`é”™è¯¯: ${error.message}`);
                }
                
                input.value = '';
                input.focus();
            }
            
            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                this.currentFile = file;
                
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = this.formatFileSize(file.size);
                
                this.calculateMD5(file).then(md5 => {
                    document.getElementById('fileMd5').textContent = md5;
                }).catch(() => {
                    document.getElementById('fileMd5').textContent = 'è®¡ç®—å¤±è´¥';
                });
                
                document.getElementById('flashBtn').disabled = !this.isConnected;
                document.getElementById('verifyBtn').disabled = !this.isConnected;
                document.getElementById('eraseBtn').disabled = !this.isConnected;
                
                this.addLog('æ–‡ä»¶', `å·²é€‰æ‹©æ–‡ä»¶: ${file.name} (${this.formatFileSize(file.size)})`);
            }
            
            async calculateMD5(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const buffer = e.target.result;
                            const hashBuffer = await crypto.subtle.digest('MD5', buffer);
                            const hashArray = Array.from(new Uint8Array(hashBuffer));
                            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                            resolve(hashHex);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            updateProgress(percent, message) {
                const progressFill = document.getElementById('progressFill');
                const progressPercent = document.getElementById('progressPercent');
                const status = document.getElementById('progressStatus');
                const speedInfo = document.getElementById('speedInfo');
                const timeInfo = document.getElementById('timeInfo');
                
                progressFill.style.width = percent + '%';
                progressPercent.textContent = percent.toFixed(1) + '%';
                status.textContent = message;
                
                if (percent > 0 && percent < 100) {
                    const speed = Math.random() * 5000 + 1000;
                    speedInfo.textContent = `âš¡ é€Ÿåº¦: ${Math.round(speed / 1024)} KB/s`;
                    
                    const remaining = Math.round((100 - percent) * 1000 / (percent * 60));
                    timeInfo.textContent = `â° å‰©ä½™: ${remaining}ç§’`;
                } else if (percent >= 100) {
                    speedInfo.textContent = 'âš¡ é€Ÿåº¦: å®Œæˆ';
                    timeInfo.textContent = 'â° å‰©ä½™: å®Œæˆ';
                }
            }
            
            showProgressBar(show) {
                const container = document.getElementById('progressContainer');
                container.style.display = show ? 'block' : 'none';
                if (!show) {
                    this.updateProgress(0, 'å‡†å¤‡åˆ·å†™...');
                }
            }
            
            addLog(type, message) {
                const now = new Date();
                const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                
                const logEntry = document.createElement('div');
                let logClass = 'info';
                if (type.includes('é”™è¯¯')) logClass = 'error';
                else if (type.includes('è­¦å‘Š')) logClass = 'warning';
                else if (type.includes('æˆåŠŸ')) logClass = 'success';
                
                logEntry.className = `log-entry ${logClass}`;
                logEntry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
                
                const container = document.getElementById('logContainer');
                container.appendChild(logEntry);
                
                if (this.autoScroll) {
                    container.scrollTop = container.scrollHeight;
                }
                
                this.logs.push({ time: now, type, message });
            }
            
            addToOutput(message) {
                const container = document.getElementById('commandOutput');
                const output = document.createElement('div');
                output.className = 'log-entry info';
                output.textContent = message;
                container.appendChild(output);
                
                if (this.autoScroll) {
                    container.scrollTop = container.scrollHeight;
                }
            }
            
            showMessage(message, type = 'info') {
                const messageDiv = document.createElement('div');
                let icon = 'âœ¨';
                if (type === 'success') icon = 'âœ¨';
                else if (type === 'warning') icon = 'âš ï¸';
                else if (type === 'error') icon = 'ğŸ’”';
                else icon = 'ğŸ’«';
                
                messageDiv.className = `magic-message ${type}`;
                messageDiv.innerHTML = `
                    <i>${icon}</i>
                    <span>${message}</span>
                `;
                
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => messageDiv.remove(), 300);
                }, 3000);
            }
            
            updateEnergyBar() {
                document.getElementById('energyFill').style.width = this.energy + '%';
                document.getElementById('energyPercent').textContent = Math.round(this.energy) + '%';
                
                if (this.energy < 20) {
                    document.getElementById('energyFill').style.background = 'linear-gradient(90deg, #ff6b6b, #fa5252)';
                } else if (this.energy < 50) {
                    document.getElementById('energyFill').style.background = 'linear-gradient(90deg, #ffd43b, #fcc419)';
                } else {
                    document.getElementById('energyFill').style.background = 'linear-gradient(90deg, var(--magic-pink), var(--magic-purple))';
                }
                
                if (this.energy < 100) {
                    setTimeout(() => {
                        this.energy = Math.min(100, this.energy + 0.5);
                        this.updateEnergyBar();
                    }, 1000);
                }
            }
            
            useEnergy(amount) {
                this.energy = Math.max(0, this.energy - amount);
                this.updateEnergyBar();
                
                if (this.energy === 0) {
                    this.showMessage('âœ¨ é­”æ³•èƒ½é‡ä¸è¶³ï¼Œè¯·ç¨ç­‰æ¢å¤...', 'warning');
                }
            }
            
            showConfirm(message, callback) {
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmModal').classList.add('active');
                
                const btn = document.getElementById('confirmActionBtn');
                const oldClick = btn.onclick;
                btn.onclick = () => {
                    callback();
                    this.hideConfirm();
                };
            }
            
            hideConfirm() {
                document.getElementById('confirmModal').classList.remove('active');
            }
        }
        
        // å…¨å±€å‡½æ•°
        let magicTool = null;
        window.addEventListener('DOMContentLoaded', () => {
            magicTool = new MagicFlashTool();
        });
        
        // è®¾å¤‡è¿æ¥
        window.connectDevice = () => magicTool?.connectDevice();
        window.disconnectDevice = () => magicTool?.disconnectDevice();
        window.refreshDevices = () => magicTool?.refreshDevices();
        
        // é•œåƒåˆ·å†™
        window.flashImage = () => magicTool?.flashImage();
        window.erasePartition = () => magicTool?.erasePartition();
        window.verifyImage = () => {
            if (!magicTool?.currentFile) {
                magicTool?.showMessage('è¯·å…ˆé€‰æ‹©é•œåƒæ–‡ä»¶', 'warning');
                return;
            }
            magicTool?.showMessage('é•œåƒéªŒè¯åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        };
        
        // åˆ†åŒºç®¡ç†
        window.getPartitions = () => magicTool?.getPartitions();
        window.backupPartition = () => magicTool?.backupPartition();
        window.restorePartition = () => {
            magicTool?.showMessage('æ¢å¤åˆ†åŒºåŠŸèƒ½å¼€å‘ä¸­...', 'info');
        };
        
        // å‘½ä»¤æ‰§è¡Œ
        window.executeCommand = () => magicTool?.executeCommand();
        window.setCommand = (cmd) => {
            document.getElementById('commandInput').value = cmd;
            document.getElementById('commandInput').focus();
        };
        
        // é«˜çº§åŠŸèƒ½
        window.confirmUnlockBootloader = () => {
            magicTool?.showConfirm('è§£é”Bootloaderä¼šæ¸…é™¤æ‰€æœ‰ç”¨æˆ·æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ', async () => {
                try {
                    magicTool?.addLog('Bootloader', 'å¼€å§‹è§£é”Bootloader...');
                    await magicTool?.sendFastbootCommand('flashing unlock');
                    magicTool?.showMessage('Bootloaderè§£é”æˆåŠŸï¼è®¾å¤‡å°†é‡å¯', 'success');
                    magicTool?.addLog('Bootloader', 'è§£é”æˆåŠŸï¼Œè®¾å¤‡é‡å¯ä¸­...');
                } catch (error) {
                    magicTool?.addLog('é”™è¯¯', `è§£é”å¤±è´¥: ${error.message}`);
                    magicTool?.showMessage(`è§£é”å¤±è´¥: ${error.message}`, 'error');
                }
            });
        };
        
        window.confirmLockBootloader = () => {
            magicTool?.showConfirm('é”å®šBootloaderå¯èƒ½å¯¼è‡´æŸäº›åŠŸèƒ½å—é™ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ', async () => {
                try {
                    magicTool?.addLog('Bootloader', 'å¼€å§‹é”å®šBootloader...');
                    await magicTool?.sendFastbootCommand('flashing lock');
                    magicTool?.showMessage('Bootloaderé”å®šæˆåŠŸï¼è®¾å¤‡å°†é‡å¯', 'success');
                    magicTool?.addLog('Bootloader', 'é”å®šæˆåŠŸï¼Œè®¾å¤‡é‡å¯ä¸­...');
                } catch (error) {
                    magicTool?.addLog('é”™è¯¯', `é”å®šå¤±è´¥: ${error.message}`);
                    magicTool?.showMessage(`é”å®šå¤±è´¥: ${error.message}`, 'error');
                }
            });
        };
        
        window.enterEDL = () => {
            magicTool?.showMessage('è¿›å…¥EDLæ¨¡å¼åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        };
        
        window.wipeAll = () => {
            magicTool?.showConfirm('ç¡®å®šè¦æ·±åº¦æ¸…ç†å—ï¼Ÿè¿™å°†æ“¦é™¤cacheã€dataåˆ†åŒºï¼', async () => {
                try {
                    magicTool?.addLog('æ¸…ç†', 'å¼€å§‹æ·±åº¦æ¸…ç†...');
                    await magicTool?.sendFastbootCommand('erase cache');
                    await magicTool?.sendFastbootCommand('erase userdata');
                    magicTool?.showMessage('æ·±åº¦æ¸…ç†å®Œæˆï¼Œè®¾å¤‡å°†é‡å¯', 'success');
                } catch (error) {
                    magicTool?.showMessage(`æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
                }
            });
        };
        
        window.formatUserData = () => {
            magicTool?.showConfirm('ç¡®å®šè¦æ ¼å¼åŒ–ç”¨æˆ·æ•°æ®åˆ†åŒºå—ï¼Ÿæ‰€æœ‰æ•°æ®å°†è¢«æ¸…é™¤ï¼', async () => {
                try {
                    await magicTool?.sendFastbootCommand('format:ext4 userdata');
                    magicTool?.showMessage('ç”¨æˆ·æ•°æ®å·²æ ¼å¼åŒ–', 'success');
                } catch (error) {
                    magicTool?.showMessage(`æ ¼å¼åŒ–å¤±è´¥: ${error.message}`, 'error');
                }
            });
        };
        
        // æ—¥å¿—ç®¡ç†
        window.clearLogs = () => {
            const container = document.getElementById('logContainer');
            container.innerHTML = `
                <div class="log-entry info">
                    <span class="log-time">[å¯åŠ¨]</span> æ—¥å¿—å·²æ¸…ç©º
                </div>
            `;
            magicTool.logs = [];
        };
        
        window.exportLogs = () => {
            if (!magicTool?.logs.length) {
                magicTool?.showMessage('æ²¡æœ‰æ—¥å¿—å¯å¯¼å‡º', 'warning');
                return;
            }
            
            const logText = magicTool.logs.map(log => 
                `[${log.time.toLocaleTimeString()}] ${log.type}: ${log.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fastboot_logs_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            magicTool?.showMessage('æ—¥å¿—å·²å¯¼å‡º', 'success');
        };
        
        // æ–‡ä»¶å¤„ç†
        window.handleFileSelect = (event) => magicTool?.handleFileSelect(event);
        
        // ç¡®è®¤å¯¹è¯æ¡†
        window.hideConfirm = () => {
            document.getElementById('confirmModal').classList.remove('active');
        };
    </script>
</body>
</html>

